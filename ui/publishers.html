<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Muli Font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <title> Congregation Scheduler </title>
  <style>
    body {
      font-family: 'Muli', sans-serif;
    }

    #title {
      text-indent: 10px;
    }

    #publisherHeaderName {
      font-size : 20px;
    }

    #publisherHeaderContent {
      font-size : 14px;
    }

    .nowrap {
        white-space: nowrap ;
    }

    .affix {
      top: 20px;
      z-index: 9999 !important;
    }

    button {
      border-radius: 10px;
    }

    .content {
      position : relative;
    }

    #button-row {
      padding-top : 5px;
      padding-bottom : 5px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    td, th {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f0f0f5;
      color: black;
      font-size : 20px;
    }
    td {
      font-size : 16px;
    }
    tr:hover {background-color: #f5f5f5;}
  </style>
</head>

<body>
  <div>
    <h1 id="title">Cupertino Congregation</h1>
  </div>


  <!-- Optional Javascript -->

  <nav class="navbar navbar navbar-default navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="/ui/home.html">Home</a>
      </div>
      <ul class="nav navbar-nav navbar-left">
        <li><a href="/ui/publishers.html">Publishers</a></li>
        <li><a href="/ui/about.html">About</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
      </ul>
    </div>
  </nav>

  <!-- Sort publishers by... section -->
  <div class="container-fluid">
    <div class="row">
      <nav class="col-xs-2">
        <div>
          <!-- Modal Trigger -->
          <button type="button" class="btn btn-info btn-md" data-toggle="modal" data-target="#addPublisherModal">Add Publisher</button>
          <ul class="nav nav-pills nav-stacked" data-spy="affix" data-offset-top="205">
            <h3>Sort by:</h3>
            <li class="active"><a href="#sortByRecentAssignment" onclick="sortPublishersBy('recent assignments')">Recent Assignments</a></li>
            <li><a href="#sortByFirstName" onclick="sortPublishersBy('first name')">First Name</a></li>
            <li><a href="#sortByLastName" onclick="sortPublishersBy('last name')">Last Name</a></li>
            <li><a href="#sortByAge" onclick="sortPublishersBy('age')">Age</a></li>
            <script>
              $(".nav li").on("click", function() {
                  $(".nav li").removeClass("active");
                  $(this).addClass("active");
                });
            </script>
          </ul>
          <!-- Modal -->
          <div id="addPublisherModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
              <!-- Modal Content -->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  <h3 class="modal-title">Publisher Information</h3>
                </div>
                <div class="modal-body container-fluid">
                  <form id="addPublisherForm" class="form-horizontal">
                    <div class="form-group">
                      <label class="col-xs-3 control-label">First Name:</label>
                      <div class="col-xs-9" style="padding-right: 50px">
                        <input id="firstNameInput" class="form-control" type="text" placeholder="本名" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-3 control-label">Last Name:</label>
                      <div class="col-xs-9" style="padding-right: 50px">
                        <input id="lastNameInput" class="form-control" type="text" placeholder="姓" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-xs-3 control-label">Age:</label>
                      <div class="col-xs-9" style="padding-right: 50px">
                        <input id="ageInput" class="form-control" type="number" placeholder="年齡">
                      </div>
                    </div>
                    <div>
                      <h4>Type:</h4>
                      <div class="col-xs-6">
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="publisher" value="PUBLISHER">
                          <label class="form-check-label" for="publisher">Publisher</label>
                        </div>
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="ubp" value="UNBAPTIZED_PUBLISHER">
                          <label class="form-check-label" for="ubp">Unbaptized Publisher</label>
                        </div>
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="pioneer" value="REGULAR_PIONEER">
                          <label class="form-check-label" for="pioneer">Regular Pioneer</label>
                        </div>
                      </div>
                      <div class"col-xs-6">
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="specialPioneer" value="SPECIAL_PIONEER">
                          <label class="form-check-label" for="specialPioneer">Special Pioneer</label>
                        </div>
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="elder" value="ELDER">
                          <label class="form-check-label" for="elder">Elder</label>
                        </div>
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="ministerialServant" value="MINISTERIAL_SERVANT">
                          <label class="form-check-label" for="ministerialServant">Ministerial Servant</label>
                        </div>
                      </div>

                    </div>
                    <div class="form-group col-xs-12">
                      <label for="notes">Notes:</label>
                      <textarea class="form-control" style="max-width: 100%; max-height:200px"
                      rows="3" type="text" id="notesInput"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                  <div id="button-row" class="pull-left">
                    <button id="addPublisherButton" class="btn btn-success" type="submit">add</button>
                    <script type="text/javascript">
                      $('#addPublisherForm').on('submit', function(e) {
                        e.preventDefault();

                        //construct URL
                        var congId = 1; //change this later
                        var url = "http://localhost:8080/api/congregation/" + congId + "/publisher";

                        //create publisher based on input
                        var pubTypes = $('input:checkbox:checked').map(function() {
                          return this.value;
                        }).get();

                        var publisher = {
                          firstName: $("#firstNameInput").val(),
                          lastName: $("#lastNameInput").val(),
                          age: $("#ageInput").val(),
                          publisherTypes: pubTypes,
                          notes: $("#notesInput").val()
                        };

                        //AJAX call
                        $.ajax({
                          url: url,
                          type: 'POST',
                          dataType: 'json',
                          contentType: "application/json; charset=utf-8",
                          data: JSON.stringify(publisher),
                        }).done(function(data) {
                          console.log("Successfully created publisher");
                        });

                        //close modal
                        $('#addPublisherModal').modal('toggle');

                      })
                    </script>
                  </div>
                  <div class="pull-right">
                    <button id="clearAll" class="btn btn-danger" type='reset'>clear all</button>
                  </div>
                </div>
                </form>
              </div>
      </nav>
      <div class="col-xs-10">
        <div class="col-xs-11 table-responsive">
          <!-- Table list of all publishers here -->
          <table class='table table-hover' id='publisherList' style="width:100%">
            <tr>
              <th>Name</th>
              <th>Age</th>
              <th>Type</th>
              <th>Recent Assignments</th>
              <th>Notes</th>
              <th>Options</th>
            </tr>
          </table>
        </div>
      </div>
      <script type="text/javascript">
        function getPublishers(congId) { //should be named getCongregationPublishers
          congId = 1; // TODO change this later
          var url = "http://localhost:8080/api/congregation/" + congId + "/publishers";

          $.ajax({
            url: url,
            type: 'GET',
            dataType: 'json',
            async: false
          }).done(function(data) {
            //console.log(data);

            for (i = 0; i < data.length; i++) {
              var name = data[i].firstName.trim() + " " + data[i].lastName.trim();
              var age = data[i].age;
              //var baptismDate = data[i].baptismDate;
              var type = data[i].publisherTypes;
              var notes = data[i].notes;
              if (notes == null) {
                notes = 'none';
              };

              var types = "<ul>";
              var j;
              type = JSON.stringify(type);
              type = type.split(",");
              for (j = 0; j < type.length; j++) {
                types += "<li>" + type[j].replace(/[\W_]+/g, " ").toLowerCase() + "</li>";
              }
              types += "</ul>";
              var tableEntry = `
              <tr>
                <td>` + name + `</td>
                <td>` + age + `</td>
                <td>` + types + `</td>
                <td>` + 'NEED RECENT ASSIGNMENTS HERE' +
                `</td>
                <td>` + notes + `</td>
                <td>
                <button id="editPublisher` + i + `" class="btn btn-warning">edit</button>
                </td>
              </tr>
              `;

              $('#publisherList').append(tableEntry);
            }
          })
        };

        // Populate table with Publishers
        //TODO replace 1 with congregation Id later on...
        getPublishers(1);

        function sortPublishersBy(type) { //from w3school
          var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
          table = document.getElementById("publisherList");
          switching = true;
          // Set the sorting direction to ascending:
          dir = "asc";
          /* Make a loop that will continue until
          no switching has been done: */
          while (switching) {
            // Start by saying: no switching is done:
            switching = false;
            rows = table.rows;
            /* Loop through all table rows (except the
            first, which contains table headers): */
            for (i = 1; i < (rows.length - 1); i++) {
              // Start by saying there should be no switching:
              shouldSwitch = false;
              // Check if the two rows should switch place:
              if (dir == "asc") {
                switch (type) {
                  case 'recent assignments':
                    console.log("not implemented yet");
                    break;
                  case 'first name':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[0];
                    x = x.innerHTML.toLowerCase().split(' ')[0];
                    y = rows[i + 1].getElementsByTagName("TD")[0];
                    y = y.innerHTML.toLowerCase().split(' ')[0];
                    if (x > y) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    }
                    break;
                  case 'last name':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[0];
                    x = x.innerHTML.toLowerCase().split(' ')[1];
                    y = rows[i + 1].getElementsByTagName("TD")[0];
                    y = y.innerHTML.toLowerCase().split(' ')[1];
                    if (x > y) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    }
                    break;
                  case 'age':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[1];
                    y = rows[i + 1].getElementsByTagName("TD")[1];
                    if (Number(x.innerHTML) > Number(y.innerHTML)) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    } else if (Number(x.innerHTML) == Number(y.innerHTML)) {
                      switchcount++;
                    }
                    break;
                }
              } else if (dir == "desc") {
                switch (type) {
                  case 'recent assignments':
                    console.log("not implemented yet");
                    break;
                  case 'first name':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[0];
                    x = x.innerHTML.toLowerCase().split(' ')[0];
                    y = rows[i + 1].getElementsByTagName("TD")[0];
                    y = y.innerHTML.toLowerCase().split(' ')[0];
                    if (x < y) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    }
                    break;
                  case 'last name':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[0];
                    x = x.innerHTML.toLowerCase().split(' ')[1];
                    y = rows[i + 1].getElementsByTagName("TD")[0];
                    y = y.innerHTML.toLowerCase().split(' ')[1];
                    if (x < y) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    }
                    break;
                  case 'age':
                    /* Get the two elements you want to compare,
                    one from current row and one from the next: */
                    x = rows[i].getElementsByTagName("TD")[1];
                    y = rows[i + 1].getElementsByTagName("TD")[1];
                    if (Number(x.innerHTML) < Number(y.innerHTML)) {
                      // If so, mark as a switch and break the loop:
                      shouldSwitch = true;
                    } else if (Number(x.innerHTML) == Number(y.innerHTML)) {
                      switchcount++;
                    }
                    break;
                }
              }
              if (shouldSwitch) {
                /* If a switch has been marked, make the switch
                and mark that a switch has been done: */
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                // Each time a switch is done, increase this count by 1:
                switchcount++;
              } else {
                /* If no switching has been done AND the direction is "asc",
                set the direction to "desc" and run the while loop again. */
                if (switchcount == 0 && dir == "asc") {
                  dir = "desc";
                  switching = true;
                }
              }
            }
          }
        }

        function updatePublisher(publisherId) {

        }
      </script>
</body>

</html>
